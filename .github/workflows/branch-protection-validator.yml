# ==========================================================
# ğŸ›¡ï¸ BRANCH PROTECTION VALIDATOR
# ==========================================================
# Enforces Three-Tier Promotion flow:
# - Features â†’ develop (via PR)
# - develop â†’ staging (via PR)
# - staging â†’ main (via PR)
# ==========================================================
name: Branch Protection Validator

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main, staging, develop]

jobs:
  validate-promotion-path:
    runs-on: ubuntu-latest
    name: Validate Branch Promotion Path
    
    steps:
      - name: Validate PR to main comes from staging
        if: github.base_ref == 'main'
        run: |
          echo "ğŸ” Validating PR to main..."
          if [ "${{ github.head_ref }}" != "staging" ]; then
            echo "âŒ ERROR: PRs to 'main' must come from 'staging' branch"
            echo "Current PR is from: ${{ github.head_ref }}"
            echo ""
            echo "âœ… Correct flow: staging â†’ main"
            echo "âŒ Invalid flow: ${{ github.head_ref }} â†’ main"
            exit 1
          fi
          echo "âœ… Valid promotion path: staging â†’ main"
      
      - name: Validate PR to staging comes from develop
        if: github.base_ref == 'staging'
        run: |
          echo "ğŸ” Validating PR to staging..."
          if [ "${{ github.head_ref }}" != "develop" ]; then
            echo "âŒ ERROR: PRs to 'staging' must come from 'develop' branch"
            echo "Current PR is from: ${{ github.head_ref }}"
            echo ""
            echo "âœ… Correct flow: develop â†’ staging"
            echo "âŒ Invalid flow: ${{ github.head_ref }} â†’ staging"
            exit 1
          fi
          echo "âœ… Valid promotion path: develop â†’ staging"
      
      - name: Validate PR to develop comes from feature branches
        if: github.base_ref == 'develop'
        run: |
          echo "ğŸ” Validating PR to develop..."
          BRANCH="${{ github.head_ref }}"
          
          # Check if branch follows feature naming convention
          if [[ ! "$BRANCH" =~ ^(feat|fix|chore)/ ]]; then
            echo "âŒ ERROR: PRs to 'develop' must come from feat/, fix/, or chore/ branches"
            echo "Current PR is from: $BRANCH"
            echo ""
            echo "âœ… Correct naming: feat/*, fix/*, chore/*"
            echo "âŒ Invalid branch: $BRANCH"
            exit 1
          fi
          echo "âœ… Valid feature branch: $BRANCH â†’ develop"
      
      - name: Display Three-Tier Promotion Flow
        if: always()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“‹ THREE-TIER PROMOTION STRATEGY"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Tier 1: feat/*, fix/*, chore/*  â†’  develop (Alpha)"
          echo "        â”œâ”€ Version: v1.0.0-alpha.X"
          echo "        â””â”€ Tests: Unit + Integration"
          echo ""
          echo "Tier 2: develop  â†’  staging (Beta)"
          echo "        â”œâ”€ Version: v1.0.0-beta.X"
          echo "        â””â”€ Tests: E2E + Performance"
          echo ""
          echo "Tier 3: staging  â†’  main (Production)"
          echo "        â”œâ”€ Version: v1.0.0"
          echo "        â””â”€ Tests: Final Sanity Checks"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
