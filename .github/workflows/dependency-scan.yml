name: Dependency Scan

on:
  schedule:
    # Run weekly on Monday at 00:00 UTC
    - cron: '0 0 * * 1'
  push:
    paths:
      - 'requirements.txt'
      - 'pyproject.toml'
      - 'poetry.lock'
  workflow_dispatch:

jobs:
  dependency-check:
    runs-on: ubuntu-latest
    name: Check Dependencies for Vulnerabilities

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run pip-audit
        id: pip_audit
        run: |
          pip install pip-audit
          pip-audit --desc || true

      - name: Run Safety check
        id: safety
        run: |
          pip install safety
          safety check --json > safety-report.json || true
          cat safety-report.json

      - name: Check for GPL licenses
        id: license_check
        run: |
          pip install pip-licenses
          pip-licenses --format=json > licenses.json
          python -c "
          import json
          with open('licenses.json') as f:
              licenses = json.load(f)
          gpl_packages = [p for p in licenses if 'GPL' in p.get('License', '')]
          if gpl_packages:
              print('Found GPL-licensed packages:')
              for p in gpl_packages:
                  print(f\"  - {p['Name']}: {p['License']}\")
              exit(1)
          else:
              print('No GPL-licensed packages found')
          "

      - name: Generate SBOM
        run: |
          pip install cyclonedx-bom
          cyclonedx-bom -o sbom.xml

      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: sbom.xml

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            let comment = '## Dependency Scan Results\n\n';

            try {
              const safetyReport = JSON.parse(fs.readFileSync('safety-report.json', 'utf8'));
              if (safetyReport.length > 0) {
                comment += '### ⚠️ Vulnerabilities Found\n\n';
                safetyReport.forEach(vuln => {
                  comment += `- **${vuln.package}**: ${vuln.vulnerability}\n`;
                });
              } else {
                comment += '### ✅ No vulnerabilities found\n\n';
              }
            } catch (e) {
              comment += '### ℹ️ Safety check completed\n\n';
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Fail on critical vulnerabilities
        run: |
          pip install safety
          safety check --json > safety-report.json
          python -c "
          import json
          import sys
          with open('safety-report.json') as f:
              vulns = json.load(f)
          critical = [v for v in vulns if v.get('severity', '').upper() in ['CRITICAL', 'HIGH']]
          if critical:
              print(f'Found {len(critical)} critical/high vulnerabilities')
              for v in critical:
                  print(f\"  - {v['package']}: {v['vulnerability']}\")
              sys.exit(1)
          "

  license-check:
    runs-on: ubuntu-latest
    name: Check Licenses

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pip-licenses

      - name: Generate license report
        run: |
          pip-licenses --format=markdown --output-file=LICENSES.md
          cat LICENSES.md

      - name: Upload license report
        uses: actions/upload-artifact@v4
        with:
          name: licenses
          path: LICENSES.md

      - name: Check for prohibited licenses
        run: |
          python -c "
          import json
          import subprocess
          result = subprocess.run(['pip-licenses', '--format=json'], capture_output=True, text=True)
          licenses = json.loads(result.stdout)
          
          prohibited = ['GPL', 'AGPL', 'SSPL']
          found_prohibited = []
          
          for pkg in licenses:
              license_str = pkg.get('License', '')
              for prohibited_license in prohibited:
                  if prohibited_license in license_str:
                      found_prohibited.append((pkg['Name'], license_str))
          
          if found_prohibited:
              print('Found prohibited licenses:')
              for name, license in found_prohibited:
                  print(f'  - {name}: {license}')
              exit(1)
          else:
              print('All licenses are permitted')
          "
